---
- name: Ensure dotfiles parent dir exists
  file:
    path: "{{ dotfiles_repo_dest | string | dirname }}"
    state: directory
    mode: "0755"

- name: Clone dotfiles repo
  git:
    repo: "{{ dotfiles_repo }}"
    dest: "{{ dotfiles_repo_dest }}"
    version: "{{ dotfiles_version }}"
  environment:
    GIT_TERMINAL_PROMPT: "0"  # reports "terminal prompts disabled" on missing password

- name: Run installation tasks (tasks/*.yml)
  include_tasks: "{{ task }}"
  loop: "{{ query('fileglob', dotfiles_repo_dest | string | expandvars ~ '/tasks/*.yml') | sort }}"
  loop_control:
    loop_var: task

- name: Append extra block to .zshrc
  blockinfile:
    path: "{{ ansible_env.ZDOTDIR | default(zshenv.ZDOTDIR) | expandvars }}/.zshrc"
    block: "{{ dotfiles_extra_zshrc }}"
  when: dotfiles_extra_zshrc
